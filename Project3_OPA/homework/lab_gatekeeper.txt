 The deployment order

1. Install Gatekeeper (once per cluster)
2. Apply the ConstraintTemplates
3. Apply the Constraints
4. Apply namespaces + apps
5. Try to “cheat” (change prod app destination to splunk-dev) → watch OPA deny it
6. Try to expose wrong Service port in prod → watch OPA deny it


helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update
kubectl create namespace gatekeeper-system

helm install gatekeeper gatekeeper/gatekeeper \
  --namespace gatekeeper-system \
  --set replicas=2

Verify 

kubectl -n gatekeeper-system get pods
kubectl get crd | grep gatekeeper
kubectl get validatingwebhookconfigurations | grep gatekeeper


kubectl apply -f 00-namespaces.yaml
kubectl get ns --show-labels | grep splunk


kubectl apply -f 10-template-argo-app-env-namespace.yaml
kubectl apply -f 11-constraint-argo-app-env-namespace.yaml

kubectl get constrainttemplates | grep k8sargoappenvironment
kubectl get constraints | grep argo-app-env-namespace-lock

kubectl apply -f 20-template-splunk-service-port-by-env.yaml
kubectl apply -f 21-constraint-splunk-service-port-by-env.yaml


kubectl get constrainttemplates | grep k8sserviceportbyenv
kubectl get constraints | grep splunk-service-port-lock

kubectl apply -f 30-app-splunk-prod.yaml
kubectl apply -f 31-app-splunk-dev.yaml
kubectl apply -f 32-app-splunk-test.yaml

kubectl -n argocd get applications

kubectl apply -f 40-cheat-prod-to-dev.yaml
Expected: Forbidden with your Gatekeeper message.

kubectl apply -f 41-cheat-prod-service-wrong-port.yaml
Expected: Forbidden
